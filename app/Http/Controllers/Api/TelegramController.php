<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Client;
use App\Models\TelegramChat;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;

class TelegramController extends Controller
{
    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° Ğ¾Ñ‚ Telegram
     */
    public function webhook(Request $request): JsonResponse
    {
        try {
            $update = $request->all();

            Log::info('Telegram webhook received', ['update' => $update]);

            // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
            if (!isset($update['message'])) {
                return response()->json(['ok' => true]);
            }

            $message = $update['message'];
            $chatId = $message['chat']['id'] ?? null;
            $username = $message['chat']['username'] ?? null;
            $firstName = $message['chat']['first_name'] ?? null;
            $text = $message['text'] ?? null;

            if (!$chatId) {
                return response()->json(['ok' => true, 'error' => 'No chat_id']);
            }

            // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‡Ğ°Ñ‚
            $telegramChat = TelegramChat::byChatId($chatId)->first();

            if (!$telegramChat) {
                $telegramChat = TelegramChat::create([
                    'chat_id' => $chatId,
                    'username' => $username ?? '',
                    'metadata' => [
                        'first_name' => $firstName,
                        'last_name' => $message['chat']['last_name'] ?? null,
                    ],
                    'is_active' => true,
                ]);
            } else {
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ username ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ¸Ğ»Ğ¸ Ğ±Ñ‹Ğ» Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼
                if ($username && ($telegramChat->username !== $username || empty($telegramChat->username))) {
                    $metadata = $telegramChat->metadata ?? [];
                    $metadata['first_name'] = $firstName;
                    if (isset($message['chat']['last_name'])) {
                        $metadata['last_name'] = $message['chat']['last_name'];
                    }
                    
                    $telegramChat->update([
                        'username' => $username,
                        'metadata' => $metadata,
                    ]);
                }
            }

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ username Ğ² Ñ‡Ğ°Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² handleMessage
            $telegramChat->refresh();

            // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾
            if ($text) {
                $this->handleMessage($telegramChat, $text, $chatId);
            }

            return response()->json(['ok' => true]);
        } catch (\Exception $e) {
            Log::error('Telegram webhook error: ' . $e->getMessage(), [
                'trace' => $e->getTraceAsString(),
            ]);

            return response()->json(['ok' => false, 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ¾Ğ´Ğ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
     */
    public function sendVerificationCode(Request $request): JsonResponse
    {
        $client = auth('client')->user();

            if (!$client) {
                return response()->json([
                    'success' => false,
                'message' => 'Unauthorized',
                ], 401);
            }

        if (!$client->telegram) {
                return response()->json([
                    'success' => false,
                'message' => 'Telegram username not specified in profile',
                ], 400);
            }

        if ($client->telegram_verified_at) {
                return response()->json([
                    'success' => false,
                'message' => 'Telegram already verified',
                ], 400);
            }

        // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´
        $code = str_pad((string) rand(0, 999999), 6, '0', STR_PAD_LEFT);

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ² ĞºĞµÑˆ Ğ½Ğ° 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (ĞºĞ»ÑÑ‡: client_id + username)
        $cacheKey = "telegram_verification:{$client->id}:{$client->telegram}";
        Cache::put($cacheKey, [
            'code' => $code,
            'client_id' => $client->id,
            'username' => $client->telegram,
        ], now()->addMinutes(5));

        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ‡Ğ°Ñ‚ Ğ¿Ğ¾ username
        $telegramChat = TelegramChat::byUsername($client->telegram)->active()->first();

        if (!$telegramChat) {
            return response()->json([
                'success' => false,
                'message' => 'Chat not found. Please send /start to the bot first',
            ], 404);
        }

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ² Telegram
        $botToken = config('services.telegram.bot_token');
        $message = "ğŸ” ĞšĞ¾Ğ´ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸: <b>{$code}</b>\n\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ´ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¼Ğ½Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.";
        $this->sendMessage($botToken, $telegramChat->chat_id, $message);

        return response()->json([
            'success' => true,
            'message' => 'Verification code sent',
            'telegram_username' => $client->telegram,
            'expires_in_minutes' => 5,
        ]);
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
     */
    public function verifyCode(Request $request): JsonResponse
    {
        $request->validate([
                'code' => 'required|string|size:6',
            ]);

        $client = auth('client')->user();

            if (!$client) {
                return response()->json([
                    'success' => false,
                'message' => 'Unauthorized',
                ], 401);
            }

        if (!$client->telegram) {
                return response()->json([
                    'success' => false,
                'message' => 'Telegram username not specified',
                ], 400);
            }

        $code = $request->input('code');

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ² ĞºĞµÑˆĞµ
        $cacheKey = "telegram_verification:{$client->id}:{$client->telegram}";
        $cachedData = Cache::get($cacheKey);

        if (!$cachedData || $cachedData['code'] !== $code) {
                return response()->json([
                    'success' => false,
                'message' => 'Invalid or expired verification code',
                ], 400);
            }

        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ‡Ğ°Ñ‚
        $telegramChat = TelegramChat::byUsername($client->telegram)->active()->first();

        if (!$telegramChat) {
                return response()->json([
                    'success' => false,
                'message' => 'Telegram chat not found',
            ], 404);
        }

        // Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ğ°Ñ‚ Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼
        $telegramChat->update([
            'client_id' => $client->id,
        ]);

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
            $client->update([
                'telegram_verified_at' => now(),
            ]);

        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· ĞºĞµÑˆĞ°
        Cache::forget($cacheKey);

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ² Telegram Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ¾Ğ¹
        $botToken = config('services.telegram.bot_token');
        $message = "âœ… Telegram ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½!\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ… Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.\n\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸:";
        $this->sendMessage($botToken, $telegramChat->chat_id, $message, true);

            return response()->json([
                'success' => true,
            'message' => 'Telegram verified successfully',
            'telegram_username' => $client->telegram,
            'verified_at' => $client->telegram_verified_at->toIso8601String(),
                'client' => $client->fresh(),
            ]);
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ°
     */
    public function checkChatExists(Request $request): JsonResponse
    {
        $client = auth('client')->user();

            if (!$client) {
                return response()->json([
                'chat_exists' => false,
                'message' => 'Unauthorized',
                ], 401);
            }

        if (!$client->telegram) {
            return response()->json([
                'chat_exists' => false,
                'message' => 'Telegram username not specified',
            ], 400);
        }

        $telegramChat = TelegramChat::byUsername($client->telegram)->active()->first();

        return response()->json([
            'chat_exists' => $telegramChat !== null,
        ]);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²ÑĞµÑ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸ Ñ‚ĞµĞºÑÑ‚)
     */
    private function handleMessage(TelegramChat $chat, string $text, int $chatId): void
    {
        $botToken = config('services.telegram.bot_token');
        $username = $chat->username;

        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾ client_id Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ğ¾ username
        $client = null;
        
        if ($chat->client_id) {
            // Ğ•ÑĞ»Ğ¸ Ñ‡Ğ°Ñ‚ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ
            $client = Client::find($chat->client_id);
        } elseif ($username) {
            // Ğ˜Ñ‰ĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ username
            $client = Client::where('telegram', $username)->first();
        }

        $command = trim(strtolower($text));

        // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start
        if ($command === '/start') {
            $this->handleStartCommand($botToken, $chatId, $client, $username);
            return;
        }

        // ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        if ($client && $client->telegram_verified_at) {
            // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ñ‡ĞµÑ€ĞµĞ· Ñ‚ĞµĞºÑÑ‚ (ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹)
            if ($command === '/account' || $command === '/profile') {
                $this->handleAccountCommand($botToken, $chatId, $client);
                return;
            }

            if ($command === '/orders' || $command === '/active') {
                $this->handleActiveOrdersCommand($botToken, $chatId, $client);
                return;
            }

            if ($command === '/history' || $command === '/archive') {
                $this->handleHistoryOrdersCommand($botToken, $chatId, $client);
                return;
            }

            // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¹ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
            $buttonText = trim($text);
            if ($buttonText === 'ğŸ‘¤ ĞĞºĞºĞ°ÑƒĞ½Ñ‚' || $buttonText === 'ĞĞºĞºĞ°ÑƒĞ½Ñ‚') {
                $this->handleAccountCommand($botToken, $chatId, $client);
                return;
            }

            if ($buttonText === 'ğŸ“‹ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹' || $buttonText === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹') {
                $this->handleActiveOrdersCommand($botToken, $chatId, $client);
                return;
            }

            if ($buttonText === 'ğŸ“š Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²' || $buttonText === 'Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²') {
                $this->handleHistoryOrdersCommand($botToken, $chatId, $client);
                return;
            }
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼
        if (preg_match('/^\d{6}$/', trim($text))) {
            $this->handleVerificationCodeFromBot($chat, trim($text), $chatId, $client, $username);
            return;
        }

        // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        $this->handleRegularMessage($botToken, $chatId, $client, $username);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start
     */
    private function handleStartCommand(string $botToken, int $chatId, ?Client $client, ?string $username): void
    {
        if (!$client) {
            // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½ĞµÑ‚ Ğ² Ğ‘Ğ”
            if ($username) {
                $message = "âŒ Ğ’Ğ°Ñˆ Telegram username (@{$username}) Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ”Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°:\n1. Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ\n2. Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username (@{$username}) Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ\n3. Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start ÑĞ½Ğ¾Ğ²Ğ°";
            } else {
                $message = "âŒ Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ”Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°:\n1. Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ\n2. Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ\n3. Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ /start ÑĞ½Ğ¾Ğ²Ğ°";
            }
            $this->sendMessage($botToken, $chatId, $message);
            return;
        }

        if ($client->telegram_verified_at) {
            // Telegram Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½ - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ
            $message = "âœ… Ğ’Ğ°Ñˆ Telegram ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½!\n\n";
            $message .= "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.\n\n";
            $message .= "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸:";
            $this->sendMessage($botToken, $chatId, $message, true);
            return;
        }

        // Username ĞµÑÑ‚ÑŒ, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½
        if ($username) {
            $message = "ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!\n\nĞ’Ğ°Ñˆ Telegram username (@{$username}) Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ½Ğ¾ ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½.\n\nĞ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ:\n1. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ\n2. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ'\n3. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ·Ğ´ĞµÑÑŒ";
        } else {
            $message = "ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!\n\nĞ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ½Ğ¾ Telegram ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½.\n\nĞ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ:\n1. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ\n2. Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ'\n3. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ·Ğ´ĞµÑÑŒ";
        }
        $this->sendMessage($botToken, $chatId, $message);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
     */
    private function handleRegularMessage(string $botToken, int $chatId, ?Client $client, ?string $username): void
    {
        if (!$client) {
            // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½ĞµÑ‚ Ğ² Ğ‘Ğ”
            if ($username) {
                $message = "âŒ Ğ’Ğ°Ñˆ Telegram username (@{$username}) Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ Ğ¸ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ.";
            } else {
                $message = "âŒ Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ Ğ¸ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ.";
            }
            $this->sendMessage($botToken, $chatId, $message);
            return;
        }

        if ($client->telegram_verified_at) {
            // Telegram Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½ - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ¸ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºÑƒ
            $message = "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ /start Ğ´Ğ»Ñ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ.";
            $this->sendMessage($botToken, $chatId, $message, true);
            return;
        }

        // Username ĞµÑÑ‚ÑŒ, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½
        $message = "â³ Ğ’Ğ°Ñˆ Telegram ĞµÑ‰Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½.\n\nĞ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ:\n1. ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚\n2. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ'\n3. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ·Ğ´ĞµÑÑŒ";
        $this->sendMessage($botToken, $chatId, $message);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ´Ğ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ°
     */
    private function handleVerificationCodeFromBot(TelegramChat $chat, string $code, int $chatId, ?Client $client, ?string $username): void
    {
        $botToken = config('services.telegram.bot_token');

        if (!$client) {
            // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½ĞµÑ‚ Ğ² Ğ‘Ğ”
            if ($username) {
                $message = "âŒ Ğ’Ğ°Ñˆ Telegram username (@{$username}) Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ Ğ¸ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ.";
            } else {
                $message = "âŒ Ğ’Ğ°Ñˆ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….\n\nĞ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ Ğ¸ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ.";
            }
            $this->sendMessage($botToken, $chatId, $message);
            return;
        }

        if ($client->telegram_verified_at) {
            // Ğ£Ğ¶Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½
            $message = "âœ… Ğ’Ğ°Ñˆ Telegram ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½! Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ… Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.\n\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸:";
            $this->sendMessage($botToken, $chatId, $message, true);
            return;
        }

        if (!$client->telegram) {
            $message = "âŒ Telegram username Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ.\n\nĞ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Telegram username Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.";
            $this->sendMessage($botToken, $chatId, $message);
            return;
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ² ĞºĞµÑˆĞµ
        $cacheKey = "telegram_verification:{$client->id}:{$client->telegram}";
        $cachedData = Cache::get($cacheKey);

        if (!$cachedData || $cachedData['code'] !== $code) {
            $this->sendMessage($botToken, $chatId, "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¸ÑÑ‚ĞµĞºÑˆĞ¸Ğ¹ ĞºĞ¾Ğ´ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸.\n\nĞ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ (ĞºĞ½Ğ¾Ğ¿ĞºĞ° 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ').");
            return;
        }

        // Ğ¡Ğ²ÑĞ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ğ°Ñ‚ Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼
        $chat->update([
            'client_id' => $client->id,
        ]);

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
        $client->update([
            'telegram_verified_at' => now(),
        ]);

        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· ĞºĞµÑˆĞ°
        Cache::forget($cacheKey);

        $message = "âœ… Telegram ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½!\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.\n\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸:";
        $this->sendMessage($botToken, $chatId, $message, true);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /account - Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğµ
     */
    private function handleAccountCommand(string $botToken, int $chatId, Client $client): void
    {
        $message = "ğŸ‘¤ <b>Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğµ</b>\n\n";
        $message .= "Ğ˜Ğ¼Ñ: {$client->full_name}\n";
        
        if ($client->phone) {
            $message .= "Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: {$client->phone}\n";
        }
        
        if ($client->email) {
            $message .= "Email: {$client->email}\n";
        }
        
        if ($client->telegram) {
            $message .= "Telegram: @{$client->telegram}\n";
        }
        
        if ($client->delivery_address) {
            $message .= "ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸: {$client->delivery_address}\n";
        }
        
        if ($client->birth_date) {
            $birthDate = is_string($client->birth_date) 
                ? \Carbon\Carbon::parse($client->birth_date)->format('d.m.Y')
                : $client->birth_date->format('d.m.Y');
            $message .= "Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ: {$birthDate}\n";
        }

        if ($client->telegram_verified_at) {
            $verifiedDate = $client->telegram_verified_at instanceof \Carbon\Carbon
                ? $client->telegram_verified_at->format('d.m.Y H:i')
                : \Carbon\Carbon::parse($client->telegram_verified_at)->format('d.m.Y H:i');
            $message .= "\nâœ… Telegram Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½: {$verifiedDate}";
        }

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ°Ñ…
        $bonusPoints = $client->bonus_points ?? 0;
        $message .= "\n\nğŸ <b>Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹:</b> {$bonusPoints}";

        $this->sendMessage($botToken, $chatId, $message, true);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /orders - Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
     */
    private function handleActiveOrdersCommand(string $botToken, int $chatId, Client $client): void
    {
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ (ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğµ issued Ğ¸ Ğ½Ğµ cancelled)
        $activeOrders = $client->orders()
            ->whereNotIn('status', [\App\Models\Order::STATUS_ISSUED, \App\Models\Order::STATUS_CANCELLED])
            ->where('is_deleted', false)
            ->orderBy('created_at', 'desc')
            ->limit(10)
            ->get();

        if ($activeOrders->isEmpty()) {
            $message = "ğŸ“‹ <b>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</b>\n\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ².";
            $this->sendMessage($botToken, $chatId, $message, true);
            return;
        }

        $message = "ğŸ“‹ <b>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</b> (" . $activeOrders->count() . ")\n\n";

        foreach ($activeOrders as $order) {
            $statusLabels = \App\Models\Order::getAvailableStatuses();
            $typeLabels = \App\Models\Order::getAvailableTypes();
            $statusLabel = $statusLabels[$order->status] ?? $order->status;
            $typeLabel = $typeLabels[$order->service_type] ?? $order->service_type;

            $message .= "ğŸ”¹ <b>{$order->order_number}</b>\n";
            $message .= "Ğ¢Ğ¸Ğ¿: {$typeLabel}\n";
            $message .= "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {$statusLabel}\n";
            
            if ($order->estimated_price) {
                $price = $this->formatPrice($order->estimated_price);
                if ($price) {
                    $message .= "Ğ¦ĞµĞ½Ğ°: {$price}\n";
                }
            }
            
            $message .= "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½: " . $order->created_at->format('d.m.Y H:i') . "\n\n";
        }

        $this->sendMessage($botToken, $chatId, $message, true);
    }

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /history - Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹
     */
    private function handleHistoryOrdersCommand(string $botToken, int $chatId, Client $client): void
    {
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹ (ÑÑ‚Ğ°Ñ‚ÑƒÑ issued Ğ¸Ğ»Ğ¸ cancelled)
        $archivedOrders = $client->orders()
            ->whereIn('status', [\App\Models\Order::STATUS_ISSUED, \App\Models\Order::STATUS_CANCELLED])
            ->where('is_deleted', false)
            ->orderBy('created_at', 'desc')
            ->limit(10)
            ->get();

        if ($archivedOrders->isEmpty()) {
            $message = "ğŸ“š <b>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²</b>\n\nĞ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ².";
            $this->sendMessage($botToken, $chatId, $message, true);
            return;
        }

        $message = "ğŸ“š <b>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²</b> (" . $archivedOrders->count() . ")\n\n";

        foreach ($archivedOrders as $order) {
            $statusLabels = \App\Models\Order::getAvailableStatuses();
            $typeLabels = \App\Models\Order::getAvailableTypes();
            $statusLabel = $statusLabels[$order->status] ?? $order->status;
            $typeLabel = $typeLabels[$order->service_type] ?? $order->service_type;

            $statusIcon = $order->status === \App\Models\Order::STATUS_ISSUED ? 'âœ…' : 'âŒ';
            
            $message .= "{$statusIcon} <b>{$order->order_number}</b>\n";
            $message .= "Ğ¢Ğ¸Ğ¿: {$typeLabel}\n";
            $message .= "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {$statusLabel}\n";
            
            if ($order->actual_price) {
                $price = $this->formatPrice($order->actual_price);
                if ($price) {
                    $message .= "Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ñ†ĞµĞ½Ğ°: {$price}\n";
                }
            } elseif ($order->estimated_price) {
                $price = $this->formatPrice($order->estimated_price);
                if ($price) {
                    $message .= "Ğ¦ĞµĞ½Ğ°: {$price}\n";
                }
            }
            
            $message .= "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½: " . $order->updated_at->format('d.m.Y H:i') . "\n\n";
        }

        $this->sendMessage($botToken, $chatId, $message, true);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
     */
    private function getMainKeyboard(): array
    {
        return [
            'keyboard' => [
                [
                    ['text' => 'ğŸ‘¤ ĞĞºĞºĞ°ÑƒĞ½Ñ‚'],
                ],
                [
                    ['text' => 'ğŸ“‹ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹'],
                    ['text' => 'ğŸ“š Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²'],
                ],
            ],
            'resize_keyboard' => true,
            'one_time_keyboard' => false,
        ];
    }

    /**
     * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
     */
    private function formatPrice($price): ?string
    {
        if (!$price || $price === '0' || $price === 0) {
            return null;
        }

        $priceFloat = (float) $price;

        // Ğ•ÑĞ»Ğ¸ Ñ†ĞµĞ½Ğ° Ñ†ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ - Ğ±ĞµĞ· ĞºĞ¾Ğ¿ĞµĞµĞº
        if ((int) $priceFloat == $priceFloat) {
            return number_format($priceFloat, 0, '', ' ') . 'â‚½';
        }

        // Ğ¡ ĞºĞ¾Ğ¿ĞµĞ¹ĞºĞ°Ğ¼Ğ¸
        return number_format($priceFloat, 2, ',', ' ') . 'â‚½';
    }

    /**
     * ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Telegram Bot API
     */
    private function sendMessage(string $botToken, int $chatId, string $text, bool $showKeyboard = false): void
    {
        $url = "https://api.telegram.org/bot{$botToken}/sendMessage";

        $data = [
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'HTML',
        ];

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
        if ($showKeyboard) {
            $data['reply_markup'] = $this->getMainKeyboard();
        }

        try {
            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 5);

            $response = curl_exec($ch);
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            curl_close($ch);

            if ($httpCode !== 200) {
                Log::error('Telegram send message failed', [
                    'http_code' => $httpCode,
                    'response' => $response,
                ]);
            }
        } catch (\Exception $e) {
            Log::error('Telegram send message exception: ' . $e->getMessage());
        }
    }
}

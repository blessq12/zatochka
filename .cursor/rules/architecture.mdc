---
description: Архитектурные правила и подходы разработки для проекта Zatochka
globs:
alwaysApply: true
---

# Архитектура проекта Zatochka

## Технологический стек

### Backend (PHP)

-   **Laravel 12.0** - основной фреймворк
-   **PHP 8.2+** - минимальная версия
-   **Filament 3.3** - админ-панель
-   **Laravel Fortify** - аутентификация
-   **Laravel Sanctum** - API токены
-   **Laravel Horizon** - управление очередями
-   **Laravel Telescope** - отладка и мониторинг

### Пакеты Spatie

-   **laravel-permission** - роли и права доступа
-   **laravel-activitylog** - логирование действий
-   **laravel-event-sourcing** - Event Sourcing
-   **laravel-data** - Data Transfer Objects
-   **laravel-query-builder** - построение запросов
-   **laravel-medialibrary** - работа с медиафайлами

### Frontend

-   **Vue 3.2** - реактивный фреймворк
-   **Tailwind CSS 4.1** - CSS фреймворк
-   **Bootstrap 5.2** - UI компоненты
-   **GSAP 3.13** - анимации
-   **Maska 3.2** - маски ввода
-   **Vite 7.0** - сборщик

### Инструменты разработки

-   **PHPStan** - статический анализ
-   **Psalm** - анализ типов
-   **PHP CS Fixer** - форматирование кода
-   **PHPUnit** - тестирование
-   **Laravel Debugbar** - отладка

## Архитектурные принципы

### 1. Гексагональная архитектура (Hexagonal Architecture)

Проект использует гексагональную архитектуру с разделением на слои:

-   **Domain** - бизнес-логика и правила (ядро приложения)
-   **Application** - Use Cases и сервисы приложения
-   **Infrastructure** - внешние зависимости (БД, API, файлы)
-   **Presentation** - UI слой (Filament, Controllers)

### 2. Use Cases Pattern

-   **Application/UseCases** - бизнес-сценарии приложения
-   Каждый Use Case решает одну задачу
-   Инкапсулирует бизнес-логику
-   Независимы от UI и инфраструктуры
-   Базовый класс `BaseOrderUseCase` с общими методами
-   Интерфейс `UseCaseInterface` для стандартизации

### 3. Event Sourcing (опционально)

-   Настроен для аудита и восстановления состояния
-   Используется только там, где это действительно нужно
-   Проекторы для построения представлений

### 4. Repository Pattern

-   Интерфейсы в Domain слое
-   Реализации в Infrastructure слое
-   Абстракция доступа к данным
-   Методы для проверки существования записей (existsByNumber)

### 5. Mapper Pattern

-   Интерфейсы мапперов в Domain слое
-   Реализации в Infrastructure слое
-   Преобразование между Domain Entity и Eloquent Model
-   Двунаправленное маппирование (toDomain, toEloquent, fromArray)

## Структура приложения

### Гексагональная архитектура

**Domain (app/Domain/)**

-   Бизнес-логика и правила
-   Сущности и Value Objects (Order Entity)
-   Интерфейсы репозиториев (OrderRepository)
-   Интерфейсы мапперов (OrderMapper)
-   Доменные события
-   Доменные сервисы (OrderNumberGeneratorService, OrderStatusGroupingService)
-   Доменные исключения (OrderNumberAlreadyExistsException, OrderException)
-   DTO для передачи данных (CreateOrderDTO, UpdateOrderDTO, GetOrderDTO)
-   Enums для типизации (OrderStatus, OrderType, OrderUrgency)
-   Factory для создания объектов (OrderFactory)

**Application (app/Application/)**

-   Use Cases - бизнес-сценарии (CreateOrderUseCase, UpdateOrderUseCase, DeleteOrderUseCase, GetOrderUseCase)
-   Базовые классы для Use Cases (BaseOrderUseCase)
-   Интерфейсы Use Cases (UseCaseInterface)
-   Сервисы приложения
-   DTO и команды
-   Интерфейсы сервисов

**Infrastructure (app/Infrastructure/)**

-   Реализации репозиториев (OrderRepositoryImpl)
-   Реализации мапперов (OrderMapperImpl)
-   Внешние API клиенты
-   Файловые системы
-   Конфигурации
-   Методы для проверки существования записей (existsByNumber)

### Модели (app/Models/)

**Основные сущности:**

-   `User` - пользователи системы (менеджеры, мастера)
-   `Client` - клиенты сервиса
-   `Company` - компании
-   `Branch` - филиалы
-   `Order` - заказы
-   `Repair` - ремонты
-   `StockItem` - товары на складе
-   `Warehouse` - склады

**Бонусная система:**

-   `BonusAccount` - бонусные счета
-   `BonusTransaction` - транзакции бонусов
-   `BonusSettings` - настройки бонусов

**Справочники:**

-   `StockCategory` - категории товаров
-   `Tool` - инструменты
-   `EquipmentType` - типы оборудования
-   `DeliveryType` - типы доставки
-   `PaymentType` - типы оплаты
-   `ToolType` - типы инструментов

### Сервисы (app/Services/)

-   `BonusService` - бизнес-логика бонусной системы

### Filament панели

-   **Manager Panel** (`/manager`) - панель менеджера
-   **Master Panel** (`/master`) - панель мастера
-   Роли: `manager`, `master`

### Провайдеры

-   `AppServiceProvider` - основные сервисы, привязки репозиториев, мапперов и доменных сервисов
-   `FortifyServiceProvider` - аутентификация
-   `HorizonServiceProvider` - очереди
-   `TelescopeServiceProvider` - мониторинг
-   `ManagerPanelProvider` - панель менеджера
-   `MasterPanelProvider` - панель мастера
-   `MiddlewareServiceProvider` - middleware для панелей

## Паттерны проектирования

### 1. Use Cases Pattern

-   Бизнес-сценарии в `app/Application/UseCases/`
-   Каждый Use Case решает одну задачу
-   Независимы от UI и инфраструктуры
-   Легко тестируются

### 2. Repository Pattern

-   Интерфейсы в Domain слое
-   Реализации в Infrastructure слое
-   Абстракция доступа к данным
-   Методы для проверки существования записей (existsByNumber)

### 3. Service Layer

-   Бизнес-логика в сервисах (`app/Services/`)
-   Тонкие контроллеры
-   Переиспользуемые сервисы

### 3.1. Domain Services

-   Доменные сервисы в `app/Domain/Service/`
-   Инкапсулируют сложную бизнес-логику
-   Независимы от инфраструктуры
-   Легко тестируются и мокаются

### 4. Factory Pattern

-   Создание сложных объектов
-   Eloquent фабрики для тестов

### 5. Observer Pattern

-   События модели
-   Автоматические действия при изменениях

### 6. Strategy Pattern

-   Различные алгоритмы расчета
-   Плагинная архитектура

### 7. Active Record

-   Прямая работа с Eloquent моделями
-   Бизнес-логика в моделях
-   Scope методы для запросов

### 8. DTO Pattern

-   Data Transfer Objects для передачи данных между слоями
-   Валидация данных в DTO
-   Immutable объекты с readonly свойствами
-   Методы fromArray() и toArray() для сериализации

### 9. Factory Pattern (Domain)

-   Доменные фабрики для создания сложных объектов
-   Статические методы create() в Entity
-   Отдельные Factory классы для сложной логики создания

### 10. Enum Pattern

-   Типизированные перечисления для статусов и типов
-   Методы для получения меток и описаний
-   Бизнес-логика в enum методах (isFinal, isManagerStatus, etc.)

### 11. State Machine Pattern

-   Управление переходами между статусами заказов
-   Сервис OrderStatusGroupingService для логики переходов
-   Валидация допустимых переходов между статусами

## Правила разработки

### 1. Модели

-   Всегда используй `HasFactory` trait
-   Обязательные `$fillable` и `$casts`
-   Scope методы для частых запросов
-   Soft deletes через `is_deleted` поле
-   UUID для пользователей
-   Использование enum полей для типизации (OrderStatus, OrderType, OrderUrgency)
-   Поддержка медиафайлов через Spatie MediaLibrary

### 2. Связи

-   Явное объявление всех связей
-   Правильные типы связей (belongsTo, hasMany, etc.)
-   Eager loading для N+1 проблем

### 3. Валидация

-   Кастомные правила в `app/Rules/`
-   Валидация на уровне формы и модели
-   Использование `PhoneFormat` для телефонов
-   Валидация в DTO

### 4. Безопасность

-   Роли и права через Spatie Permission
-   Middleware для защиты роутов
-   CSRF защита
-   Rate limiting для API

### 5. Производительность

-   Индексы в миграциях
-   Кэширование через Redis
-   Очереди для тяжелых операций
-   Eager loading связей

### 6. Тестирование

-   Unit тесты для сервисов
-   Feature тесты для API
-   Фабрики для тестовых данных
-   Моки для внешних сервисов

### 7. Код-стайл

-   PSR-12 стандарт
-   PHPStan level 0
-   Psalm для типизации
-   Автоформатирование через Pint

### 8. Dependency Injection

-   Привязка интерфейсов к реализациям в AppServiceProvider
-   Singleton для репозиториев и мапперов
-   Автоматическое внедрение зависимостей в Use Cases
-   Использование app() helper для получения сервисов

### 9. Domain Entity

-   Immutable объекты с приватными свойствами
-   Только getter методы для доступа к данным
-   Бизнес-методы для проверки состояний
-   Mutator методы для изменения состояния
-   Factory методы для создания объектов
-   Методы toArray() для сериализации

## Команды разработки

```bash
# Запуск в dev режиме
composer dev

# Анализ кода
composer analyse

# Тестирование
composer test

# Исправление стиля
composer fix
```

## Структура базы данных

### Основные таблицы

-   `users` - пользователи системы
-   `clients` - клиенты
-   `companies` - компании
-   `branches` - филиалы
-   `orders` - заказы (с enum полями для типизации)
-   `stock_items` - товары
-   `warehouses` - склады
-   `stock_movements` - движения товаров
-   `repairs` - ремонты
-   `reviews` - отзывы
-   `notifications` - уведомления

### Аудит и логирование

-   `activity_log` - логи действий
-   `stored_events` - события Event Sourcing
-   `order_logs` - логи заказов

### Бонусная система

-   `bonus_accounts` - бонусные счета
-   `bonus_transactions` - транзакции
-   `bonus_settings` - настройки

## Интеграции

### Telegram

-   Уведомления через `laravel-notification-channels/telegram`
-   Модели `TelegramChat`, `TelegramMessage`

### Медиафайлы

-   `spatie/laravel-medialibrary` для файлов
-   Привязка к заказам и другим сущностям
-   Таблица `media` для хранения метаданных файлов

## Новые архитектурные решения

### 1. Domain Entity Pattern

-   Полноценные доменные сущности вместо простых моделей
-   Инкапсуляция бизнес-логики в Entity
-   Immutable объекты с контролируемыми изменениями
-   Бизнес-методы для проверки состояний

### 2. Enum-based Status Management

-   Типизированные статусы через PHP 8.1+ Enums
-   Бизнес-логика в enum методах
-   Автоматическая валидация переходов между статусами
-   Группировка статусов по ролям (менеджер/мастер)

### 3. Use Case Architecture

-   Базовый класс для стандартизации Use Cases
-   Интерфейс для типизации Use Cases
-   Разделение валидации и выполнения
-   Интеграция с DTO для передачи данных

### 4. Mapper Layer

-   Отдельный слой для преобразования данных
-   Двунаправленное маппирование между слоями
-   Типизированные интерфейсы мапперов
-   Изоляция Domain от Infrastructure

### 5. State Machine для заказов

-   Централизованное управление переходами статусов
-   Валидация допустимых переходов
-   Группировка статусов по ролям пользователей
-   Автоматическое определение доступных действий

### Очереди

-   Horizon для мониторинга
-   Фоновые задачи для бонусов

## Мониторинг и отладка

### Telescope

-   Запросы к БД
-   Очереди
-   События
-   Логи

### Debugbar

-   Профилирование запросов
-   Переменные
-   Время выполнения

### Логирование

-   Activity Log для действий пользователей
-   Laravel Log для системных событий
-   Кастомные логи для бизнес-событий

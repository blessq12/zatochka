---
description: Архитектурные правила и подходы разработки для проекта Zatochka
globs:
alwaysApply: true
---

# Архитектура проекта Zatochka

## Технологический стек

### Backend (PHP)

-   **Laravel 12.0** - основной фреймворк
-   **PHP 8.2+** - минимальная версия
-   **Filament 3.3** - админ-панель
-   **Laravel Fortify** - аутентификация
-   **Laravel Sanctum** - API токены
-   **Laravel Horizon** - управление очередями
-   **Laravel Telescope** - отладка и мониторинг

### Пакеты Spatie

-   **laravel-permission** - роли и права доступа
-   **laravel-activitylog** - логирование действий
-   **laravel-event-sourcing** - Event Sourcing
-   **laravel-data** - Data Transfer Objects
-   **laravel-query-builder** - построение запросов
-   **laravel-medialibrary** - работа с медиафайлами

### Frontend

-   **Vue 3.2** - реактивный фреймворк
-   **Tailwind CSS 4.1** - CSS фреймворк
-   **Bootstrap 5.2** - UI компоненты
-   **GSAP 3.13** - анимации
-   **Maska 3.2** - маски ввода
-   **Vite 7.0** - сборщик

### Инструменты разработки

-   **PHPStan** - статический анализ
-   **Psalm** - анализ типов
-   **PHP CS Fixer** - форматирование кода
-   **PHPUnit** - тестирование
-   **Laravel Debugbar** - отладка

## Архитектурные принципы

### 1. Гексагональная архитектура (Hexagonal Architecture)

Проект использует гексагональную архитектуру с разделением на слои:

-   **Domain** - бизнес-логика и правила (ядро приложения)
-   **Application** - Use Cases и сервисы приложения
-   **Infrastructure** - внешние зависимости (БД, API, файлы)
-   **Presentation** - UI слой (Filament, Controllers)

### 2. Use Cases Pattern

-   **Application/UseCases** - бизнес-сценарии приложения
-   Каждый Use Case решает одну задачу
-   Инкапсулирует бизнес-логику
-   Независимы от UI и инфраструктуры

### 3. Event Sourcing (опционально)

-   Настроен для аудита и восстановления состояния
-   Используется только там, где это действительно нужно
-   Проекторы для построения представлений

### 4. Repository Pattern

-   Интерфейсы в Domain слое
-   Реализации в Infrastructure слое
-   Абстракция доступа к данным

## Структура приложения

### Гексагональная архитектура

**Domain (app/Domain/)**

-   Бизнес-логика и правила
-   Сущности и Value Objects
-   Интерфейсы репозиториев
-   Доменные события

**Application (app/Application/)**

-   Use Cases - бизнес-сценарии
-   Сервисы приложения
-   DTO и команды
-   Интерфейсы сервисов

**Infrastructure (app/Infrastructure/)**

-   Реализации репозиториев
-   Внешние API клиенты
-   Файловые системы
-   Конфигурации

### Модели (app/Models/)

**Основные сущности:**

-   `User` - пользователи системы (менеджеры, мастера)
-   `Client` - клиенты сервиса
-   `Company` - компании
-   `Branch` - филиалы
-   `Order` - заказы
-   `Repair` - ремонты
-   `StockItem` - товары на складе
-   `Warehouse` - склады

**Бонусная система:**

-   `BonusAccount` - бонусные счета
-   `BonusTransaction` - транзакции бонусов
-   `BonusSettings` - настройки бонусов

**Справочники:**

-   `ServiceType` - типы услуг
-   `OrderStatus` - статусы заказов
-   `StockCategory` - категории товаров
-   `Tool` - инструменты
-   `EquipmentType` - типы оборудования

### Сервисы (app/Services/)

-   `BonusService` - бизнес-логика бонусной системы

### Filament панели

-   **Manager Panel** (`/manager`) - панель менеджера
-   **Master Panel** (`/master`) - панель мастера
-   Роли: `manager`, `master`

### Провайдеры

-   `AppServiceProvider` - основные сервисы
-   `FortifyServiceProvider` - аутентификация
-   `HorizonServiceProvider` - очереди
-   `TelescopeServiceProvider` - мониторинг
-   `ManagerPanelProvider` - панель менеджера
-   `MasterPanelProvider` - панель мастера

## Паттерны проектирования

### 1. Use Cases Pattern

-   Бизнес-сценарии в `app/Application/UseCases/`
-   Каждый Use Case решает одну задачу
-   Независимы от UI и инфраструктуры
-   Легко тестируются

### 2. Repository Pattern

-   Интерфейсы в Domain слое
-   Реализации в Infrastructure слое
-   Абстракция доступа к данным

### 3. Service Layer

-   Бизнес-логика в сервисах (`app/Services/`)
-   Тонкие контроллеры
-   Переиспользуемые сервисы

### 4. Factory Pattern

-   Создание сложных объектов
-   Eloquent фабрики для тестов

### 5. Observer Pattern

-   События модели
-   Автоматические действия при изменениях

### 6. Strategy Pattern

-   Различные алгоритмы расчета
-   Плагинная архитектура

### 7. Active Record

-   Прямая работа с Eloquent моделями
-   Бизнес-логика в моделях
-   Scope методы для запросов

## Правила разработки

### 1. Модели

-   Всегда используй `HasFactory` trait
-   Обязательные `$fillable` и `$casts`
-   Scope методы для частых запросов
-   Soft deletes через `is_deleted` поле
-   UUID для пользователей

### 2. Связи

-   Явное объявление всех связей
-   Правильные типы связей (belongsTo, hasMany, etc.)
-   Eager loading для N+1 проблем

### 3. Валидация

-   Кастомные правила в `app/Rules/`
-   Валидация на уровне формы и модели
-   Использование `PhoneFormat` для телефонов

### 4. Безопасность

-   Роли и права через Spatie Permission
-   Middleware для защиты роутов
-   CSRF защита
-   Rate limiting для API

### 5. Производительность

-   Индексы в миграциях
-   Кэширование через Redis
-   Очереди для тяжелых операций
-   Eager loading связей

### 6. Тестирование

-   Unit тесты для сервисов
-   Feature тесты для API
-   Фабрики для тестовых данных
-   Моки для внешних сервисов

### 7. Код-стайл

-   PSR-12 стандарт
-   PHPStan level 0
-   Psalm для типизации
-   Автоформатирование через Pint

## Команды разработки

```bash
# Запуск в dev режиме
composer dev

# Анализ кода
composer analyse

# Тестирование
composer test

# Исправление стиля
composer fix
```

## Структура базы данных

### Основные таблицы

-   `users` - пользователи системы
-   `clients` - клиенты
-   `companies` - компании
-   `branches` - филиалы
-   `orders` - заказы
-   `stock_items` - товары
-   `warehouses` - склады

### Аудит и логирование

-   `activity_log` - логи действий
-   `stored_events` - события Event Sourcing
-   `order_logs` - логи заказов

### Бонусная система

-   `bonus_accounts` - бонусные счета
-   `bonus_transactions` - транзакции
-   `bonus_settings` - настройки

## Интеграции

### Telegram

-   Уведомления через `laravel-notification-channels/telegram`
-   Модели `TelegramChat`, `TelegramMessage`

### Медиафайлы

-   `spatie/laravel-medialibrary` для файлов
-   Привязка к заказам и другим сущностям

### Очереди

-   Redis для очередей
-   Horizon для мониторинга
-   Фоновые задачи для бонусов

## Мониторинг и отладка

### Telescope

-   Запросы к БД
-   Очереди
-   События
-   Логи

### Debugbar

-   Профилирование запросов
-   Переменные
-   Время выполнения

### Логирование

-   Activity Log для действий пользователей
-   Laravel Log для системных событий
-   Кастомные логи для бизнес-событий

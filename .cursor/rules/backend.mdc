---
name: backend
glob:
alwaysApply: true
---

# Backend Rules

## Architecture

### Simple Laravel Architecture

-   **Models**: Eloquent models with business logic
-   **Services**: Business logic and complex operations
-   **Controllers**: API endpoints and request handling
-   **Resources**: Filament admin panels

### Service Layer Pattern

-   **Services**: Contain business logic and complex operations
-   **Models**: Data representation and simple business rules
-   **Controllers**: Handle HTTP requests and responses
-   **Resources**: Filament admin interface

## Stack

### Core

-   **Laravel 12.0** + **PHP 8.2+**
-   **Eloquent ORM** - работа с базой данных
-   **Spatie Data 4.17** - типизированные объекты (если нужно)
-   **Spatie Query Builder 6.3** - построение запросов

### Admin & API

-   **Filament 3.3** - админ-панель
-   **Laravel Sanctum 4.0** - API токены
-   **Laravel Fortify 1.30** - аутентификация

### Infrastructure

-   **Laravel Horizon 5.33** + **Redis queues** - фоновые задачи
-   **Laravel Telescope 5.11** - профилирование
-   **Spatie Media Library 11.0** - управление файлами

### Quality

-   **PHPStan 2.1** + **Psalm 6.13** - статический анализ
-   **PHPUnit 11.5.3** - тестирование
-   **Laravel Pint 1.24** + **PHP CS Fixer 3.87** - форматирование

## Rules

### Service Layer

-   **Services**: Содержат бизнес-логику и сложные операции
-   **Models**: Простые бизнес-правила и валидация
-   **Controllers**: Обработка HTTP запросов
-   **Soft Delete**: через `deleted_at` timestamp

### Filament Integration

-   **Resources**: Работают напрямую с Eloquent моделями
-   **Services**: Вызываются в Pages для сложной бизнес-логики
-   **Override**: `handleRecordCreation()`, `mutateFormDataBeforeSave()`, `before()` с `halt()`
-   **Notifications**: Всегда показывать success/error уведомления

### API Controllers

-   **Validation**: Laravel validation в контроллерах
-   **Services**: Вызов сервисов для бизнес-логики
-   **Try-catch**: Обработка ошибок с правильными HTTP статусами
-   **JSON**: Консистентная структура ответов

### Models

-   **Business Logic**: Простые методы в моделях
-   **Relationships**: Eloquent relationships
-   **Validation**: Model validation rules
-   **Scopes**: Query scopes для переиспользования

## Naming Conventions

-   **Models**: `{Entity}` (Order, Client, Repair)
-   **Services**: `{Entity}Service` (OrderService, ClientService)
-   **Controllers**: `{Entity}Controller` (OrderController, ClientController)
-   **Resources**: `{Entity}Resource` (OrderResource, ClientResource)

## Development Workflow

1. **New Feature**: Model → Service → Controller/Resource → Tests
2. **Business Logic**: В Services, простые правила в Models
3. **Error Handling**: Exceptions в Services, Notifications в UI
4. **Testing**: Unit tests для Services, Feature tests для API/UI

## Anti-Patterns (НЕ ДЕЛАТЬ)

❌ **Сложная архитектура для простых задач**
❌ **Event Sourcing для CRUD операций**
❌ **Use Cases для простой бизнес-логики**
❌ **Repository pattern поверх Eloquent**
❌ **Мапперы для простых моделей**
❌ **Агрегаты для простых сущностей**
❌ **Сложные DTO для простых данных**
❌ **Интерфейсы без необходимости**
❌ **Оверинжиниринг архитектуры**
❌ **Игнорирование простоты Laravel**

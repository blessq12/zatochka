---
name: backend-arch
glob:
alwaysApply: true
---

# Backend Architecture Rules

## Domain-Driven Design Structure

-   **Domain Layer**: Entities (readonly), AggregateRoots (Event Sourcing), Events (immutable), Repositories (interfaces only), Mappers (interfaces only), Enums, Exceptions, DTOs, Services, Factories
-   **Application Layer**: Use Cases with Template Method pattern
-   **Infrastructure Layer**: Repository implementations, Mapper implementations

## Event Sourcing Rules

-   **Flow**: Commands → UseCase → AggregateRoot → Events → Projectors (read models) + Reactors (side effects)
-   **Queries**: Use Repository (read models)
-   **State Changes**: Only through events
-   **Business Rules**: Managed by AggregateRoots

## Use Cases Pattern (Template Method)

-   **Base Class**: `Base{Domain}UseCase` with constructor injecting ALL domain dependencies via `app()`
-   **Dependencies**: All repositories and mappers available through protected properties
-   **Child Classes**: NO constructors, use inherited dependencies
-   **Chain**: `loadData() → validate() → execute()`
-   **Validation**: Abstract method `validateSpecificData()`
-   **Return**: Domain entities or data arrays

## Infrastructure Rules

-   **Repository Pattern**: Interface in Domain, Implementation in Infrastructure
-   **Mappers**: Isolate Domain from ORM
-   **Soft Delete**: Via `is_deleted` flag
-   **Transactions**: In Use Cases, not Repository

## Filament Integration Rules

-   **Resources**: Work with Eloquent models
-   **Use Cases**: Called in Pages for business logic
-   **CreateRecord**: Override `handleRecordCreation()`
-   **EditRecord**: Override `mutateFormDataBeforeSave()`
-   **DeleteAction**: Override `before()` with `halt()`
-   **Notifications**: Always show success/error messages
-   **Error Handling**: Try-catch with informative messages

## Controllers Rules

-   **API Controllers**: Use Use Cases with proper chain `loadData()->validate()->execute()`
-   **Validation**: Laravel validation in controller, business validation in Use Cases
-   **Error Handling**: Try-catch with proper HTTP status codes
-   **Response**: Return JSON with consistent structure

## Reactors Rules (Event Sourcing Side Effects)

-   **Dependency Injection**: Inject repositories through constructor, NOT app()
-   **Repository Usage**: Use Repository interfaces, NEVER direct Eloquent calls
-   **Use Cases**: Call Use Cases for business operations
-   **Error Handling**: Log errors, don't break event processing
-   **No Direct DB**: All data access through Repository pattern

## Naming Conventions

-   **Entities**: `{Domain}Entity` or `{Domain}`
-   **Events**: `{Domain}{Action}`
-   **Use Cases**: `{Action}{Domain}UseCase`
-   **Repositories**: `{Domain}Repository` (interface), `{Domain}RepositoryImpl` (implementation)
-   **Mappers**: `{Domain}Mapper` (interface), `{Domain}MapperImpl` (implementation)

## Development Workflow

1. **New Domain**: Create Domain structure → Entity → Events → AggregateRoot → Repository interfaces → Mapper interfaces → Use Cases structure → Infrastructure implementations → Filament Resource
2. **Event Sourcing**: Command → UseCase → AggregateRoot → recordThat(Event) → Projector + Reactor
3. **Error Handling**: Domain exceptions in Domain/Exception/, validation in Use Cases, Filament Notifications for UI
4. **Testing**: Unit tests for Domain, Integration tests for Use Cases, Feature tests for API

## Anti-Patterns (НЕ ДЕЛАТЬ)

❌ **Прямые вызовы Eloquent в Use Cases/Reactors**
❌ **Бизнес-логика в Controllers или Resources**
❌ **Изменение состояния через прямые SQL запросы**
❌ **Смешивание Domain и Infrastructure слоев**
❌ **Создание Events без AggregateRoot**
❌ **Использование Eloquent моделей как Domain Entities**
❌ **Создание конструкторов в дочерних Use Cases классов**
❌ **Дублирование зависимостей в каждом Use Case**
❌ **Использование app() в дочерних классах Use Cases**
❌ **Прямые Eloquent вызовы в Reactors**
❌ **Использование app() в Reactors для получения Repository**
❌ **Неиспользуемые DTO классы в Use Cases**
❌ **Неправильная цепочка вызова Use Cases в Controllers**

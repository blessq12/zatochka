<template>
    <div class="client-profile-edit" ref="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            </h2>
            <p class="text-gray-600 dark:text-gray-400">
                –û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            </p>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <form @submit.prevent="handleSubmit" class="space-y-6">
            <!-- –§–ò–û -->
            <div class="space-y-2">
                <label
                    class="block text-sm font-semibold text-gray-700 dark:text-white"
                >
                    –§–ò–û
                </label>
                <div class="relative">
                    <input
                        type="text"
                        v-model="formData.full_name"
                        class="w-full px-4 py-3 pl-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-300"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
                        :class="{
                            'border-red-500 focus:border-red-500 focus:ring-red-500/20':
                                errors.full_name,
                        }"
                        @focus="handleFieldFocus"
                        @blur="handleFieldBlur"
                        ref="fullNameInput"
                    />
                    <i
                        class="mdi mdi-account absolute left-3 top-1/2 transform -translate-y-1/2 text-accent text-lg"
                    ></i>
                </div>
                <span
                    v-if="errors.full_name"
                    class="text-red-500 text-sm font-medium"
                    ref="errorFullName"
                    >{{ errors.full_name }}</span
                >
            </div>

            <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
            <div class="space-y-2">
                <label
                    class="block text-sm font-semibold text-gray-700 dark:text-white"
                >
                    –¢–µ–ª–µ—Ñ–æ–Ω
                </label>
                <div class="relative">
                    <input
                        type="tel"
                        v-model="formData.phone"
                        class="w-full px-4 py-3 pl-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-300"
                        placeholder="+7 (___) ___-__-__"
                        v-maska
                        data-maska="+7 (###) ###-##-##"
                        :class="{
                            'border-red-500 focus:border-red-500 focus:ring-red-500/20':
                                errors.phone,
                        }"
                        @focus="handleFieldFocus"
                        @blur="handleFieldBlur"
                        ref="phoneInput"
                    />
                    <i
                        class="mdi mdi-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-accent text-lg"
                    ></i>
                </div>
                <span
                    v-if="errors.phone"
                    class="text-red-500 text-sm font-medium"
                    ref="errorPhone"
                    >{{ errors.phone }}</span
                >
            </div>

            <!-- Telegram -->
            <div class="space-y-2">
                <label
                    class="block text-sm font-semibold text-gray-700 dark:text-white"
                >
                    Telegram
                </label>
                <div class="relative">
                    <input
                        type="text"
                        v-model="formData.telegram"
                        class="w-full px-4 py-3 pl-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-300"
                        placeholder="@username"
                        :class="{
                            'border-red-500 focus:border-red-500 focus:ring-red-500/20':
                                errors.telegram,
                        }"
                        @focus="handleFieldFocus"
                        @blur="handleFieldBlur"
                        ref="telegramInput"
                    />
                    <i
                        class="mdi mdi-telegram absolute left-3 top-1/2 transform -translate-y-1/2 text-accent text-lg"
                    ></i>
                </div>
                <span
                    v-if="errors.telegram"
                    class="text-red-500 text-sm font-medium"
                    ref="errorTelegram"
                    >{{ errors.telegram }}</span
                >
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    –£–∫–∞–∂–∏—Ç–µ username –±–µ–∑ @ (–Ω–∞–ø—Ä–∏–º–µ—Ä: username)
                </p>
            </div>

            <!-- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è -->
            <div class="space-y-2">
                <label
                    class="block text-sm font-semibold text-gray-700 dark:text-white"
                >
                    –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                </label>
                <div class="relative">
                    <input
                        type="date"
                        v-model="formData.birth_date"
                        class="w-full px-4 py-3 pl-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-300"
                        :class="{
                            'border-red-500 focus:border-red-500 focus:ring-red-500/20':
                                errors.birth_date,
                        }"
                        @focus="handleFieldFocus"
                        @blur="handleFieldBlur"
                        ref="birthDateInput"
                    />
                    <i
                        class="mdi mdi-cake absolute left-3 top-1/2 transform -translate-y-1/2 text-accent text-lg"
                    ></i>
                </div>
                <span
                    v-if="errors.birth_date"
                    class="text-red-500 text-sm font-medium"
                    ref="errorBirthDate"
                    >{{ errors.birth_date }}</span
                >
            </div>

            <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class="space-y-2">
                <label
                    class="block text-sm font-semibold text-gray-700 dark:text-white"
                >
                    –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
                </label>
                <div class="relative">
                    <textarea
                        v-model="formData.delivery_address"
                        rows="3"
                        class="w-full px-4 py-3 pl-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-300 resize-none"
                        placeholder="–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"
                        :class="{
                            'border-red-500 focus:border-red-500 focus:ring-red-500/20':
                                errors.delivery_address,
                        }"
                        @focus="handleFieldFocus"
                        @blur="handleFieldBlur"
                        ref="deliveryAddressInput"
                    ></textarea>
                    <i
                        class="mdi mdi-map-marker absolute left-3 top-3 text-accent text-lg"
                    ></i>
                </div>
                <span
                    v-if="errors.delivery_address"
                    class="text-red-500 text-sm font-medium"
                    ref="errorDeliveryAddress"
                    >{{ errors.delivery_address }}</span
                >
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex space-x-3 pt-4">
                <button
                    type="button"
                    @click="handleCancel"
                    class="flex-1 flex justify-center items-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all duration-200 transform hover:scale-105"
                >
                    <i class="mdi mdi-close mr-2"></i>
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button
                    type="submit"
                    :disabled="loading"
                    class="flex-1 flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-gradient-to-r from-accent to-pink-600 hover:from-accent/90 hover:to-pink-600/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all duration-200 transform hover:scale-105 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none"
                    ref="submitButton"
                >
                    <i v-if="loading" class="mdi mdi-loading mdi-spin mr-2"></i>
                    <i v-else class="mdi mdi-content-save mr-2"></i>
                    {{ loading ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" }}
                </button>
            </div>
        </form>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–ø–µ—Ö–µ -->
        <div
            v-if="error"
            class="mt-6 p-4 bg-red-100 dark:bg-red-900/20 border border-red-500 rounded-lg"
            ref="errorMessage"
        >
            <div class="flex items-center">
                <i
                    class="mdi mdi-alert-circle text-red-600 dark:text-red-400 text-2xl mr-3"
                ></i>
                <div>
                    <p class="font-bold text-red-800 dark:text-red-200">
                        –û—à–∏–±–∫–∞!
                    </p>
                    <p class="text-red-700 dark:text-red-300">{{ error }}</p>
                </div>
            </div>
        </div>

        <div
            v-if="success"
            class="mt-6 p-4 bg-green-100 dark:bg-green-900/20 border border-green-500 rounded-lg"
            ref="successMessage"
        >
            <div class="flex items-center">
                <i
                    class="mdi mdi-check-circle text-green-600 dark:text-green-400 text-2xl mr-3"
                ></i>
                <div>
                    <p class="font-bold text-green-800 dark:text-green-200">
                        –£—Å–ø–µ—à–Ω–æ!
                    </p>
                    <p class="text-green-700 dark:text-green-300">
                        –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω
                    </p>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { gsap } from "gsap";
import { useAuthStore } from "../../stores/auth.js";
import { profileEditSchema, validateForm } from "../../validation/schemas.js";

export default {
    name: "ClientProfileEdit",
    props: {
        client: {
            type: Object,
            required: true,
        },
    },
    emits: ["profile-updated", "cancel"],
    data() {
        return {
            formData: {
                full_name: "",
                phone: "",
                telegram: "",
                birth_date: "",
                delivery_address: "",
            },
            success: false,
            errors: {},
        };
    },
    computed: {
        authStore() {
            return useAuthStore();
        },
        loading() {
            return this.authStore.getLoading;
        },
        error() {
            return this.authStore.getError;
        },
    },
    mounted() {
        this.initializeForm();
        this.animateComponentEnter();
    },
    methods: {
        // –ü—Ä–∏–≤–æ–¥–∏–º –¥–∞—Ç—É –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM-DD –¥–ª—è input[type="date"]
        toYMD(value) {
            if (!value) return "";
            // –ï—Å–ª–∏ —É–∂–µ YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
            // –ï—Å–ª–∏ ISO 8601
            if (/^\d{4}-\d{2}-\d{2}T/.test(value)) return value.slice(0, 10);
            // –ï—Å–ª–∏ DD.MM.YYYY
            const dmY = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
            if (dmY) return `${dmY[3]}-${dmY[2]}-${dmY[1]}`;
            try {
                const d = new Date(value);
                if (!isNaN(d)) {
                    const mm = String(d.getMonth() + 1).padStart(2, "0");
                    const dd = String(d.getDate()).padStart(2, "0");
                    return `${d.getFullYear()}-${mm}-${dd}`;
                }
            } catch (_) {}
            return "";
        },
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        animateComponentEnter() {
            if (!this.$refs.container) return;

            gsap.fromTo(
                this.$refs.container,
                {
                    opacity: 0,
                    y: 30,
                    scale: 0.95,
                },
                {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    duration: 0.6,
                    ease: "back.out(1.7)",
                }
            );
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏ –ø–æ–ª—è - —Ç—Ä—è—Å–∫–∞
        animateFieldError(field) {
            if (!field) return;

            gsap.to(field, {
                x: [-8, 8, -8, 8, -4, 4, 0],
                duration: 0.6,
                ease: "power2.out",
            });
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ–ª—è —Å –æ—à–∏–±–∫–æ–π
        highlightErrorField(field) {
            if (!field) return;

            gsap.to(field, {
                borderColor: "#ef4444",
                boxShadow: "0 0 0 3px rgba(239, 68, 68, 0.2)",
                duration: 0.3,
                ease: "power2.out",
            });
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏
        showErrorText(errorElement) {
            if (!errorElement) return;

            gsap.fromTo(
                errorElement,
                {
                    opacity: 0,
                    scale: 0.8,
                    y: -10,
                },
                {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    duration: 0.4,
                    ease: "back.out(1.7)",
                }
            );
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–ª–µ
        animateFieldFocus(field) {
            if (!field) return;

            gsap.to(field, {
                scale: 1.02,
                duration: 0.2,
                ease: "power2.out",
            });
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
        animateFieldBlur(field) {
            if (!field) return;

            gsap.to(field, {
                scale: 1,
                duration: 0.2,
                ease: "power2.out",
            });
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        animateSuccess() {
            if (!this.$refs.successMessage) return;

            gsap.fromTo(
                this.$refs.successMessage,
                {
                    opacity: 0,
                    scale: 0.8,
                    y: 20,
                },
                {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    duration: 0.5,
                    ease: "back.out(1.7)",
                }
            );
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
        animateError() {
            if (!this.$refs.errorMessage) return;

            gsap.fromTo(
                this.$refs.errorMessage,
                {
                    opacity: 0,
                    y: -30,
                    scale: 0.9,
                },
                {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    duration: 0.5,
                    ease: "back.out(1.7)",
                }
            );
        },

        handleFieldFocus(event) {
            this.animateFieldFocus(event.target);
        },

        handleFieldBlur(event) {
            this.animateFieldBlur(event.target);
        },

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞
        initializeForm() {
            console.log("üîç Client data in initializeForm:", this.client);
            console.log("üîç birth_date from client:", this.client.birth_date);
            console.log(
                "üîç delivery_address from client:",
                this.client.delivery_address
            );

            const birthYmd = this.toYMD(this.client.birth_date);
            console.log("üîç birthYmd formatted:", birthYmd);

            this.formData = {
                full_name: this.client.full_name || "",
                phone: this.client.phone || "",
                telegram: this.client.telegram
                    ? this.client.telegram.startsWith("@")
                        ? this.client.telegram
                        : `@${this.client.telegram}`
                    : "",
                birth_date: birthYmd,
                delivery_address: this.client.delivery_address || "",
            };

            console.log("üîç Form data initialized:", this.formData);
        },

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async handleSubmit() {
            this.errors = {};

            try {
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitData = { ...this.formData };

                // –£–±–∏—Ä–∞–µ–º @ –∏–∑ Telegram username –µ—Å–ª–∏ –µ—Å—Ç—å
                if (
                    submitData.telegram &&
                    submitData.telegram.startsWith("@")
                ) {
                    submitData.telegram = submitData.telegram.substring(1);
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
                const validationResult = await validateForm(
                    profileEditSchema,
                    submitData
                );

                if (!validationResult.isValid) {
                    this.errors = validationResult.errors;
                    this.animateValidationErrors();
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await this.authStore.updateProfile(submitData);
                console.log("üîç Update profile response:", response);

                const updated =
                    (response &&
                        response.data &&
                        (response.data.user || response.data.client)) ||
                    null;

                console.log("üîç Updated client data:", updated);

                this.success = true;
                this.$emit("profile-updated", updated);

                // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                this.$nextTick(() => {
                    this.animateSuccess();
                });

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    this.$emit("cancel");
                }, 2000);
            } catch (error) {
                this.error = error.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è";
                this.$nextTick(() => {
                    this.animateError();
                });
            }
        },

        // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        animateValidationErrors() {
            this.$nextTick(() => {
                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è —Å –æ—à–∏–±–∫–æ–π
                if (this.errors.full_name && this.$refs.fullNameInput) {
                    this.animateFieldError(this.$refs.fullNameInput);
                    this.highlightErrorField(this.$refs.fullNameInput);
                    this.showErrorText(this.$refs.errorFullName);
                }
                if (this.errors.phone && this.$refs.phoneInput) {
                    this.animateFieldError(this.$refs.phoneInput);
                    this.highlightErrorField(this.$refs.phoneInput);
                    this.showErrorText(this.$refs.errorPhone);
                }
                if (this.errors.telegram && this.$refs.telegramInput) {
                    this.animateFieldError(this.$refs.telegramInput);
                    this.highlightErrorField(this.$refs.telegramInput);
                    this.showErrorText(this.$refs.errorTelegram);
                }
                if (this.errors.birth_date && this.$refs.birthDateInput) {
                    this.animateFieldError(this.$refs.birthDateInput);
                    this.highlightErrorField(this.$refs.birthDateInput);
                    this.showErrorText(this.$refs.errorBirthDate);
                }
                if (
                    this.errors.delivery_address &&
                    this.$refs.deliveryAddressInput
                ) {
                    this.animateFieldError(this.$refs.deliveryAddressInput);
                    this.highlightErrorField(this.$refs.deliveryAddressInput);
                    this.showErrorText(this.$refs.errorDeliveryAddress);
                }
            });
        },

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
        handleCancel() {
            this.$emit("cancel");
        },
    },
};
</script>

<style scoped>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π */
.client-profile-edit {
    transition: all 0.3s ease;
}

/* –≠—Ñ—Ñ–µ–∫—Ç hover –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
button:hover {
    transform: translateY(-1px);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
.mdi {
    transition: all 0.2s ease;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ø–æ–ª–µ–π –ø—Ä–∏ hover */
input:hover,
textarea:hover {
    transform: translateY(-1px);
    transition: all 0.3s ease;
}
</style>

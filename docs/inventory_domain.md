### Домен «Склад»: структура и логика

Этот документ описывает текущее состояние сущностей, моделей и сервисов склада, инварианты и бизнес-процессы, а также точки интеграции с остальными подсистемами.

---

### Модели БД (Eloquent)

-   InventoryItem (`app/Models/InventoryItem.php`)

    -   Поля: `name`, `sku`, `quantity:int`, `unit`, `min_stock:int`, `is_deleted:bool`
    -   Связи: `transactions()` → hasMany `InventoryTransaction`
    -   Скоупы: `active()`, `lowStock()`

-   InventoryTransaction (`app/Models/InventoryTransaction.php`)
    -   Поля: `item_id`, `type` (in|out|adjust — см. ниже), `quantity:int`, `order_id`, `description`
    -   Связи: `item()` → belongsTo `InventoryItem`, `order()` → belongsTo `Order`, `user()` → belongsTo `User`

Примечания:

-   Количество хранится целым числом; единица измерения в поле `unit` у `InventoryItem`.
-   Тип транзакции — строка; на практике используются как минимум приход/расход/корректировка (если требуется точный enum — фиксируется на уровне UI/домена).

---

### Доменные классы (`app/Domain/Inventory`)

-   Entities

    -   `Entities/InventoryItem.php` — доменная проекция номенклатуры и остатков (агрегат).
    -   `Entities/InventoryTransaction.php` — доменная транзакция движения.

-   Events

    -   `Events/StockChanged.php` — событие изменения остатков по позиции.

-   Services
    -   `Services/InventoryService.php` — доменная логика работы со складом (приход, расход, корректировки, проверки инвариантов).

Дополнительно (Application-слой):

-   `app/Application/Inventory/AddItem.php` — сценарий прихода (пополнение).
-   `app/Application/Inventory/DeductStock.php` — сценарий расхода (списание).
-   `app/Application/Inventory/DTO/InventoryDTO.php` — передача данных.

Инфраструктура:

-   `app/Infrastructure/Persistence/Eloquent/Repositories/EloquentInventoryRepository.php` — репозиторий (файл присутствует, реализация ожидается/расширяется под потребности домена).

---

### Инварианты и бизнес‑правила

-   Остаток не может уходить в отрицательные значения (кроме явно разрешённой корректировки типа `adjust`, если такая политика введена).
-   Все изменения остатков фиксируются транзакциями `InventoryTransaction`.
-   Расход по заказу должен ссылаться на `order_id` (трейсабельность).
-   Порог `min_stock` сигнализирует о необходимости пополнения (используется для алертов/виджетов).

Типы транзакций (рекомендация домена):

-   `in` — приход (пополнение склада)
-   `out` — расход (списание под заказ/производство)
-   `adjust` — корректировка (инвентаризация, пересорт, порча)

---

### Бизнес‑процессы

-   Приход (AddItem):

    -   Валидация входных данных (SKU/товар существует, количество > 0).
    -   Увеличение `quantity` у `InventoryItem` на `quantity` транзакции.
    -   Создание `InventoryTransaction` с `type = in` и описанием/пользователем.
    -   Эмит события `StockChanged`.

-   Расход (DeductStock):

    -   Проверка достаточности остатка; отказ при дефиците.
    -   Уменьшение `quantity` у `InventoryItem`.
    -   Создание `InventoryTransaction` с `type = out`, привязка к `order_id`.
    -   Эмит события `StockChanged`.

-   Корректировка (Adjust):
    -   Явное действие ответственного пользователя.
    -   Изменение `quantity` на delta (плюс/минус), запись транзакции `adjust` с комментарием.

Все операции выполняются в БД‑транзакции (Unit of Work) для согласованности.

---

### Точки интеграции

-   Заказы:

    -   При смене статуса заказа на этап, когда материал должен быть списан, вызывается сценарий `DeductStock` по позициям.
    -   При отмене/возврате — опциональный возврат на склад (обратная транзакция `in` с пометкой).

-   Уведомления/сигналы:
    -   Реакция на `min_stock` (виджеты/уведомления менеджеру) — вне домена, через UI/крон/слушателей событий.

---

### Панель (Filament)

-   Ресурс `InventoryResource` уже присутствует (списки/создание/просмотр/редактирование). Для строгой доменной логики рекомендуется вызывать Application‑сценарии из Actions.
-   Виджеты «Низкий остаток», «Движение по SKU» — опционально, вне домена.

---

### Готовность/пробелы

-   Доменные сущности/сервисы и сценарии присутствуют; репозиторий `EloquentInventoryRepository` требует наполнения/актуализации под новые use‑cases.
-   Явных VO (value object) для единиц/количеств/SKU нет — можно добавить при усилении инвариантов (например, `StockQuantity`, `Sku`).
-   Политики блокировок и предотвращения гонок (оптимистичная версия/блокировка строки) — зависят от нагрузки; при необходимости добавить в репозиторий.
-   Единообразные enum‑значения `type` транзакций следует закрепить (в домене и в UI).

---

### Минимальный чек‑лист внедрения

-   Заполнить `EloquentInventoryRepository` методами: получить/сохранить `InventoryItem`, записать `InventoryTransaction`, агрегаты по остаткам.
-   Обернуть `AddItem`/`DeductStock` в транзакции БД.
-   В местах бизнес‑процесса (изменение статуса заказа) дергать `DeductStock`.
-   В `InventoryResource` Actions вызывать Application‑сценарии вместо прямого `Model::save()` (для соблюдения инвариантов домена).

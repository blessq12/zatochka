# План разработки полноценной системы лояльности

## 1. Создание структуры базы данных

### 1.1 Миграция для таблицы бонусов клиентов

-   Таблица `client_bonuses` с полями: id, client_id, balance, total_earned, total_spent, expires_at, created_at, updated_at
-   Индексы для быстрого поиска по client_id
-   Поле expires_at для отслеживания 3-месячного срока действия

### 1.2 Миграция для истории операций с бонусами

-   Таблица `bonus_transactions` с полями: id, client_id, order_id, type (earn/spend), amount, description, created_at
-   Связи с клиентами и заказами

### 1.3 Миграция для настроек бонусной системы

-   Таблица `bonus_settings` с полями: key, value, description
-   Хранение курса бонусов, минимальных сумм, процентов начисления

## 2. Обновление моделей

### 2.1 Модель ClientBonus

-   Связи с Client и BonusTransaction
-   Методы для начисления и списания бонусов
-   Валидация баланса
-   Методы для проверки срока действия (3 месяца с последней операции)

### 2.2 Модель BonusTransaction

-   Связи с Client, Order
-   Методы для создания транзакций
-   Логирование всех операций

### 2.3 Модель BonusSetting

-   Кэширование настроек
-   Методы для получения значений

### 2.4 Обновление модели Client

-   Связь с ClientBonus
-   Методы для работы с бонусами
-   Получение текущего баланса

### 2.5 Обновление модели Order

-   Связь с BonusTransaction
-   Методы для расчета бонусов за заказ

## 3. Расширение BonusService

### 3.1 Методы начисления бонусов

-   Начисление 5% от суммы заказа (минимум 1500₽)
-   Начисление 1000 бонусов за день рождения
-   Начисление 1000 бонусов за первый отзыв
-   Начисление только после полного завершения заказа

### 3.2 Методы списания бонусов

-   Курс 1:1 (1 бонус = 1 рубль)
-   Минимум 3000₽ для списания
-   Максимум 50% от стоимости заказа
-   Приоритет: сначала бонусы, потом скидки
-   Проверка достаточности баланса

### 3.3 Методы расчета

-   Расчет доступных бонусов для заказа
-   Расчет максимальной скидки (50% от суммы)
-   Валидация правил использования
-   Проверка минимальных сумм

### 3.4 Методы уведомлений

-   Уведомления о начислении бонусов
-   Уведомления о списании бонусов
-   Уведомления о достижении лимитов
-   Уведомления о скором истечении срока бонусов

### 3.5 Методы управления сроком действия

-   Автоматическое обновление expires_at при операциях
-   Проверка срока действия бонусов
-   Методы для списания просроченных бонусов

## 4. Интеграция с существующими сервисами

### 4.1 OrderService

-   Автоматическое начисление бонусов при закрытии заказа (5% от суммы)
-   Учет бонусов при расчете финальной цены
-   Проверка возможности использования бонусов (минимум 3000₽)
-   Применение бонусов перед скидками

### 4.2 CalculationService

-   Интеграция бонусов в расчет стоимости
-   Расчет скидки от бонусов (максимум 50% от суммы заказа)
-   Учет минимальных сумм для бонусов

### 4.3 NotificationService

-   Уведомления о бонусах через Telegram
-   Уведомления о бонусах через SMS
-   Персонализированные сообщения
-   Уведомления о скором истечении срока

## 5. События и слушатели

### 5.1 События

-   BonusEarned - при начислении бонусов
-   BonusSpent - при списании бонусов
-   BonusLimitReached - при достижении лимитов
-   BonusExpiring - при скором истечении срока

### 5.2 Слушатели

-   SendBonusNotification - отправка уведомлений
-   UpdateClientBonusBalance - обновление баланса
-   LogBonusTransaction - логирование операций
-   UpdateBonusExpiration - обновление срока действия

## 6. Обновление админ-панели

### 6.1 Ресурс ClientBonusResource

-   Просмотр баланса бонусов клиентов
-   История транзакций
-   Ручное начисление/списание бонусов
-   Отображение срока действия бонусов

### 6.2 Ресурс BonusTransactionResource

-   Просмотр всех транзакций
-   Фильтрация по типам и датам
-   Экспорт отчетов

### 6.3 Обновление OrderResource

-   Поле для ввода бонусов к списанию
-   Отображение доступных бонусов клиента
-   Автоматический расчет скидки (максимум 50%)
-   Проверка минимальной суммы для списания (3000₽)

### 6.4 Обновление ClientResource

-   Отображение баланса бонусов
-   История бонусных операций
-   Статистика по бонусам
-   Отображение срока действия бонусов

### 6.5 Виджеты для дашборда

-   Топ клиентов по бонусам
-   Статистика начислений/списаний
-   Графики активности бонусной системы
-   Количество просроченных бонусов

## 7. Настройки и конфигурация

### 7.1 Расширение страницы Settings

-   Настройки курса бонусов (1:1)
-   Минимальная сумма для начисления (1500₽)
-   Минимальная сумма для списания (3000₽)
-   Максимальный лимит списания (50% от суммы заказа)
-   Процент начисления за заказ (5%)
-   Срок действия бонусов (3 месяца)
-   Суммы бонусов за день рождения (1000) и отзывы (1000)

### 7.2 Конфигурационные файлы

-   config/bonuses.php с настройками системы
-   Кэширование настроек для производительности

## 8. API и интеграции

### 8.1 API методы

-   Получение баланса бонусов клиента
-   История транзакций
-   Расчет доступных бонусов для заказа
-   Проверка срока действия бонусов

### 8.2 Интеграция с Telegram ботом

-   Команды для проверки баланса
-   Уведомления о бонусах
-   Интерактивные кнопки для работы с бонусами
-   Уведомления о скором истечении срока

## 9. Тестирование

### 9.1 Unit тесты

-   Тесты BonusService
-   Тесты моделей бонусов
-   Тесты расчетов и валидаций
-   Тесты срока действия бонусов

### 9.2 Feature тесты

-   Тесты API методов
-   Тесты интеграции с заказами
-   Тесты уведомлений
-   Тесты минимальных сумм и лимитов

### 9.3 Тесты производительности

-   Тесты с большим количеством транзакций
-   Тесты кэширования настроек

## 10. Документация и развертывание

### 10.1 Документация

-   Описание системы лояльности
-   Инструкции для администраторов
-   API документация

### 10.2 Миграции и сидеры

-   Миграции для создания таблиц
-   Сидеры с базовыми настройками
-   Скрипты для переноса данных

### 10.3 Мониторинг

-   Логирование операций с бонусами
-   Алерты при аномалиях
-   Метрики использования системы
-   Мониторинг просроченных бонусов

## 11. Автоматизация

### 11.1 Команды Artisan

-   Команда для списания просроченных бонусов
-   Команда для начисления бонусов за день рождения
-   Команда для генерации отчетов по бонусам

### 11.2 Планировщик задач

-   Ежедневная проверка просроченных бонусов
-   Еженедельная отправка уведомлений о скором истечении
-   Ежемесячная генерация отчетов

---

**Приоритеты разработки:**

1. База данных и модели (основа)
2. BonusService и интеграция с заказами (функционал)
3. Админ-панель (управление)
4. API и уведомления (пользователи)
5. Тестирование и документация (качество)

**Ожидаемый результат:**
Полноценная система лояльности с возможностью начисления, списания, отслеживания и управления бонусами клиентов, интегрированная в существующую CRM систему.

**Ключевые параметры системы:**

-   Курс бонусов: 1:1 (1 бонус = 1 рубль)
-   Начисление: 5% от суммы заказа (минимум 1500₽)
-   Списание: минимум 3000₽, максимум 50% от суммы заказа
-   Срок действия: 3 месяца с последней операции
-   День рождения: 1000 бонусов
-   Первый отзыв: 1000 бонусов
